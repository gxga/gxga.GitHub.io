<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/web3@1.5.2/dist/web3.min.js"></script>
  <title>Document</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    body {
      display: flex;
      align-items: center;
      flex-direction: column;
      padding-top: 20px;
    }

    textarea {
      width: 500px;
      height: 400px;
    }

    button {
      width: 180px;
      height: 50px;
      margin-top: 20px;
    }

  </style>
</head>

<body>
  <div>
    <h2>串联一条直线</h2>
  </div>
  <textarea placeholder="请粘贴私钥"></textarea>
  <button>绑定</button>
</body>
<script src="./web3.js"></script>
<script>
  let web3, address;

  window.onload = () => {
    initAddress();
    web3 = new Web3(window.ethereum);
  }

  function initAddress() {
    window.ethereum.request({ method: 'eth_requestAccounts' }).then(accounts => {
      address = accounts[0];
    })

    window.ethereum.on('accountsChanged', accounts => {
      address = accounts[0];
    })
  }

  document.getElementsByTagName('button')[0].onclick = async () => {
    const privateKeys = document.getElementsByTagName('textarea')[0].value.split(/[\n,]/).map(value => value.trim());

    // 合约ABI      合约地址
    const abi = [{
      "inputs": [
        {
          "internalType": "address",
          "name": "parent",
          "type": "address"
        }
      ],
      "name": "makeRelation",
      "outputs": [],
      "stateMutability": "nonpayable",
      "type": "function"
    }], contractAddr = '0xb54Cbbb64Dd8504D74361e1E4baf305e8498c5C9';
    
    const contract = new web3.eth.Contract(abi, contractAddr);

    for (let i = 0; i < privateKeys.length; i++) {
      let account = await web3.eth.accounts.privateKeyToAccount(privateKeys[i]), prevAccount;

      if (i > 0) {
        prevAccount = await web3.eth.accounts.privateKeyToAccount(privateKeys[i - 1]);
      }

      const parent = prevAccount ? prevAccount.address : address;
      const self = account.address;

      const signature = await sign(contract, parent, privateKeys[i]);
      sendSignedTransaction(signature, parent, self);
    }
  }

  function sign(contract, parent, privateKey) {
    return new Promise(async resolve => {
      try {
        // makeRelation 绑定的方法名，根据合约修改
        const data = contract.methods.makeRelation(parent).encodeABI();

        web3.eth.accounts.signTransaction({
          data,
          to: contract.options.address,
          gas: 2000000
        }, privateKey).then(signature => resolve(signature.rawTransaction));
      } catch (error) {
        resolve(await sign(contract, parent, privateKey));
      }
    })
  }

  function sendSignedTransaction(signature, parent, self) {
    web3.eth.sendSignedTransaction(signature)
      .on('receipt', () => {
        console.log('绑定成功：');
        console.log('自己：', self);
        console.log('上级：', parent);
      }).on('error', () => {
        console.log('绑定失败：');
        console.log('自己：', self);
        console.log('上级：', parent);
      })
  }
</script>

</html>
